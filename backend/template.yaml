AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Data Banana serverless backend

Globals:
  Function:
    Timeout: 15
    Runtime: python3.11
    MemorySize: 256
    Environment:
      Variables:
        DB_HOST: !Ref DatabaseHost
        DB_NAME: !Ref DatabaseName
        DB_USER: !Ref DatabaseUser
        DB_PASSWORD: !Ref DatabasePassword
        STRIPE_SECRET: !Ref StripeSecret
        S3_BUCKET: !Ref ImageBucket
        ANTHROPIC_API_KEY: !Ref AnthropicApiKey
        GEMINI_API_KEY: !Ref GeminiApiKey
        FRONTEND_URL: !Ref FrontendUrl
  Api:
    Cors:
      AllowMethods: "'GET,POST,PUT,OPTIONS'"
      AllowHeaders: "'Content-Type,Authorization'"
      AllowOrigin: "'*'"
    Auth:
      Authorizers:
        CognitoAuthorizer:
          UserPoolArn: !GetAtt UserPool.Arn

Parameters:
  DatabaseHost:
    Type: String
    Description: PostgreSQL database host
  DatabaseName:
    Type: String
    Description: Database name
  DatabaseUser:
    Type: String
    Description: Database username
  DatabasePassword:
    Type: String
    NoEcho: true
    Description: Database password
  StripeSecret:
    Type: String
    NoEcho: true
    Description: Stripe secret key
  AnthropicApiKey:
    Type: String
    NoEcho: true
    Description: Anthropic Claude API key
  GeminiApiKey:
    Type: String
    NoEcho: true
    Description: Gemini API key for Nano Banana service
  FrontendUrl:
    Type: String
    Description: Frontend URL for Stripe redirect URLs
    Default: http://localhost:5173

Resources:
  UserPool:
    Type: AWS::Cognito::UserPool
    Properties:
      UserPoolName: !Sub "${AWS::StackName}-users"
      UsernameAttributes:
        - email
      Policies:
        PasswordPolicy:
          MinimumLength: 8
          RequireUppercase: false
          RequireLowercase: false
          RequireNumbers: false
          RequireSymbols: false

  UserPoolClient:
    Type: AWS::Cognito::UserPoolClient
    Properties:
      UserPoolId: !Ref UserPool
      ClientName: !Sub "${AWS::StackName}-client"
      GenerateSecret: false

  ImageBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub "${AWS::StackName}-images"
      CorsConfiguration:
        CorsRules:
          - AllowedHeaders: ["*"]
            AllowedMethods: [GET, PUT, POST, DELETE]
            AllowedOrigins: ["*"]

  # Database Lambda Functions
  UserFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambdas/
      Handler: user.handler
      Events:
        GetUser:
          Type: Api
          Properties:
            Path: /user
            Method: get
            Auth:
              Authorizer: CognitoAuthorizer
        UpdateCredits:
          Type: Api
          Properties:
            Path: /user/credits
            Method: post
            Auth:
              Authorizer: CognitoAuthorizer

  BatchFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambdas/
      Handler: batch.handler
      Events:
        GetBatches:
          Type: Api
          Properties:
            Path: /batches
            Method: get
            Auth:
              Authorizer: CognitoAuthorizer
        CreateBatch:
          Type: Api
          Properties:
            Path: /batches
            Method: post
            Auth:
              Authorizer: CognitoAuthorizer

  ImageFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambdas/
      Handler: image.handler
      Events:
        GetImages:
          Type: Api
          Properties:
            Path: /images
            Method: get
            Auth:
              Authorizer: CognitoAuthorizer
        UpdateImage:
          Type: Api
          Properties:
            Path: /images/{id}
            Method: put
            Auth:
              Authorizer: CognitoAuthorizer

  GenerateFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambdas/
      Handler: generate.handler
      Timeout: 60
      MemorySize: 512
      Events:
        Generate:
          Type: Api
          Properties:
            Path: /generate
            Method: post
            Auth:
              Authorizer: CognitoAuthorizer

  PaymentFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambdas/
      Handler: payment.handler
      Events:
        Payment:
          Type: Api
          Properties:
            Path: /payment
            Method: post
            Auth:
              Authorizer: CognitoAuthorizer

  UploadFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambdas/
      Handler: upload.handler
      Policies:
        - S3CrudPolicy:
            BucketName: !Ref ImageBucket
      Events:
        Upload:
          Type: Api
          Properties:
            Path: /upload
            Method: post
            Auth:
              Authorizer: CognitoAuthorizer

  ExportFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambdas/
      Handler: export.handler
      Timeout: 300
      MemorySize: 1024
      Policies:
        - S3CrudPolicy:
            BucketName: !Ref ImageBucket
      Events:
        Export:
          Type: Api
          Properties:
            Path: /export
            Method: post
            Auth:
              Authorizer: CognitoAuthorizer

  WebhookFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambdas/
      Handler: webhook.handler
      Events:
        Webhook:
          Type: Api
          Properties:
            Path: /webhook
            Method: post

Outputs:
  ApiGatewayApi:
    Description: "API Gateway endpoint URL"
    Value: !Sub "https://${ServerlessRestApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/"
  
  UserPoolId:
    Description: "Cognito User Pool ID"
    Value: !Ref UserPool
    
  UserPoolClientId:
    Description: "Cognito User Pool Client ID"  
    Value: !Ref UserPoolClient